local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- [[ KONFIGURASI ]] --
local API_URL = "https://glitchmods.my.id/api/server.php"
local GET_KEY_URL = "https://glitchmods.my.id/"
local SERVICE_NAME = "glitchv1"
local SAVE_FILE = "GlitchKey_Config.txt" -- Nama file simpanan

-- [[ PENANGANAN UI (PARENTING) ]] --
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "GlitchSystem_Premium"
ScreenGui.ResetOnSpawn = false

local function ProtectUI()
    local success, _ = pcall(function()
        local CoreGui = game:GetService("CoreGui")
        ScreenGui.Parent = CoreGui
    end)
    if not success then
        ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    end
end
ProtectUI()

-- [[ CONTAINER UTAMA ]] --
local Main = Instance.new("Frame", ScreenGui)
Main.Name = "MainFrame"
Main.AnchorPoint = Vector2.new(0.5, 0.5)
Main.Position = UDim2.new(0.5, 0, 0.5, 0)
Main.Size = UDim2.new(0, 0, 0, 0)
Main.BackgroundColor3 = Color3.fromRGB(15, 15, 18)
Main.BorderSizePixel = 0
Main.ClipsDescendants = true
Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 12)

local UIStroke = Instance.new("UIStroke", Main)
UIStroke.Color = Color3.fromRGB(90, 0, 255)
UIStroke.Thickness = 2
UIStroke.Transparency = 0.4

-- [[ DRAGGING SYSTEM ]] --
local UserInputService = game:GetService("UserInputService")
local dragging, dragInput, dragStart, startPos
Main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true; dragStart = input.Position; startPos = Main.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
Main.InputChanged:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- [[ ELEMENT LOGIN ]] --
local LoginFrame = Instance.new("Frame", Main)
LoginFrame.Size = UDim2.new(1, 0, 1, 0)
LoginFrame.BackgroundTransparency = 1

local Title = Instance.new("TextLabel", LoginFrame)
Title.Size = UDim2.new(1, 0, 0, 60)
Title.Text = "GLITCH PREMIUM"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 22
Title.BackgroundTransparency = 1

local InputKey = Instance.new("TextBox", LoginFrame)
InputKey.Size = UDim2.new(0.8, 0, 0, 45)
InputKey.Position = UDim2.new(0.1, 0, 0.30, 0) -- Sedikit naik untuk ruang tombol baru
InputKey.PlaceholderText = "Paste License Key..."
InputKey.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
InputKey.TextColor3 = Color3.new(1, 1, 1)
InputKey.Font = Enum.Font.Gotham
Instance.new("UICorner", InputKey)

-- [[ TOMBOL TAMBAHAN (PASTE & LOAD) ]] --
local PasteBtn = Instance.new("TextButton", LoginFrame)
PasteBtn.Size = UDim2.new(0.38, 0, 0, 25)
PasteBtn.Position = UDim2.new(0.1, 0, 0.50, 0)
PasteBtn.Text = "PASTE"
PasteBtn.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
PasteBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
PasteBtn.Font = Enum.Font.GothamMedium
PasteBtn.TextSize = 11
Instance.new("UICorner", PasteBtn)

local LoadBtn = Instance.new("TextButton", LoginFrame)
LoadBtn.Size = UDim2.new(0.38, 0, 0, 25)
LoadBtn.Position = UDim2.new(0.52, 0, 0.50, 0)
LoadBtn.Text = "LOAD SAVED KEY"
LoadBtn.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
LoadBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
LoadBtn.Font = Enum.Font.GothamMedium
LoadBtn.TextSize = 11
Instance.new("UICorner", LoadBtn)

local LoginBtn = Instance.new("TextButton", LoginFrame)
LoginBtn.Size = UDim2.new(0.8, 0, 0, 40)
LoginBtn.Position = UDim2.new(0.1, 0, 0.65, 0)
LoginBtn.Text = "LOGIN"
LoginBtn.BackgroundColor3 = Color3.fromRGB(90, 0, 255)
LoginBtn.TextColor3 = Color3.new(1, 1, 1)
LoginBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", LoginBtn)

local GetKeyBtn = Instance.new("TextButton", LoginFrame)
GetKeyBtn.Size = UDim2.new(1, 0, 0, 30)
GetKeyBtn.Position = UDim2.new(0, 0, 0.85, 0)
GetKeyBtn.Text = "Don't have a key? Click here"
GetKeyBtn.BackgroundTransparency = 1
GetKeyBtn.TextColor3 = Color3.fromRGB(180, 180, 180)
GetKeyBtn.Font = Enum.Font.Gotham
GetKeyBtn.TextSize = 12

local Notify = Instance.new("TextLabel", Main)
Notify.Size = UDim2.new(1, 0, 0, 30)
Notify.Position = UDim2.new(0, 0, 1, 10)
Notify.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
Notify.BackgroundTransparency = 0.1
Notify.TextColor3 = Color3.new(1, 1, 1)
Notify.Font = Enum.Font.GothamMedium
Notify.TextSize = 12

local function ShowNotify(msg, color)
    Notify.Text = msg
    Notify.BackgroundColor3 = color or Color3.fromRGB(255, 50, 50)
    TweenService:Create(Notify, TweenInfo.new(0.5, Enum.EasingStyle.Back), {Position = UDim2.new(0, 0, 0.9, 0)}):Play()
    task.delay(3, function()
        TweenService:Create(Notify, TweenInfo.new(0.5), {Position = UDim2.new(0, 0, 1, 10)}):Play()
    end)
end

-- [[ FITUR SAVE/LOAD ]] --
local function SaveKey(key)
    if writefile then
        writefile(SAVE_FILE, key)
    end
end

local function LoadKey()
    if isfile and isfile(SAVE_FILE) then
        return readfile(SAVE_FILE)
    end
    return nil
end

-- [[ TRANSISI ANIMASI & PENGIRIMAN DATA ]] --
local function LaunchAnimation(scriptData, userData)
    TweenService:Create(LoginFrame, TweenInfo.new(0.5), {Position = UDim2.new(0, 0, -1, 0)}):Play()
    
    local BarBG = Instance.new("Frame", Main)
    BarBG.Size = UDim2.new(0.7, 0, 0, 3)
    BarBG.Position = UDim2.new(0.15, 0, 0.5, 0)
    BarBG.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    
    local BarFill = Instance.new("Frame", BarBG)
    BarFill.Size = UDim2.new(0, 0, 1, 0)
    BarFill.BackgroundColor3 = Color3.fromRGB(90, 0, 255)
    
    local StatusText = Instance.new("TextLabel", Main)
    StatusText.Text = "LOADING PREMIUM MODULES..."
    StatusText.Position = UDim2.new(0, 0, 0.4, 0)
    StatusText.Size = UDim2.new(1, 0, 0, 20)
    StatusText.TextColor3 = Color3.new(1,1,1)
    StatusText.BackgroundTransparency = 1
    StatusText.Font = Enum.Font.GothamMedium

    TweenService:Create(BarFill, TweenInfo.new(2), {Size = UDim2.new(1, 0, 1, 0)}):Play()
    task.wait(2.2)

    TweenService:Create(Main, TweenInfo.new(0.8, Enum.EasingStyle.Quart), {Size = UDim2.new(0, 450, 0, 300)}):Play()
    BarBG:Destroy()
    StatusText.TextSize = 18
    StatusText.Text = "WELCOME TO GLITCH PREMIUM"
    
    _G.UserName = userData.username or "User"
    _G.UserRole = userData.role or "FREE"
    _G.Expiry = userData.expiry or "Unlimited"
    _G.UserKey = userData.key
    
    local loader = loadstring or syn and syn.loadstring
    if loader then 
        local success, err = pcall(function() task.spawn(loader(scriptData)) end)
        if not success then warn("Loader Error: " .. err) end
    end
    
    task.wait(2)
    ScreenGui:Destroy()
end

-- [[ LOGIN LOGIC ]] --
LoginBtn.MouseButton1Click:Connect(function()
    local key = InputKey.Text
    if key == "" then ShowNotify("⚠ Key cannot be empty!") return end
    LoginBtn.Text = "VERIFYING..."
    
    local hwid = "Unknown"
    pcall(function() hwid = game:GetService("RbxAnalyticsService"):GetClientId() end)
    
    local url = API_URL .. "?key=" .. key .. "&hwid=" .. hwid .. "&service=" .. SERVICE_NAME
    local success, response = pcall(function() return game:HttpGet(url) end)

    if success then
        local data = HttpService:JSONDecode(response)
        if data.status == "success" then
            SaveKey(key) -- Simpan key saat login berhasil
            LaunchAnimation(data.script, {
                username = data.username,
                role = data.role,
                expiry = data.expiry,
                key = key
            })
        else
            LoginBtn.Text = "LOGIN"
            ShowNotify("✕ " .. (data.message or "Invalid Key"))
        end
    else
        LoginBtn.Text = "LOGIN"
        ShowNotify("✕ Connection Error")
    end
end)

-- [[ FITUR TOMBOL BARU ]] --
PasteBtn.MouseButton1Click:Connect(function()
    if getclipboard then
        InputKey.Text = getclipboard()
        ShowNotify("✓ Key pasted!", Color3.fromRGB(90, 0, 255))
    else
        ShowNotify("✕ Clipboard not supported")
    end
end)

LoadBtn.MouseButton1Click:Connect(function()
    local saved = LoadKey()
    if saved then
        InputKey.Text = saved
        ShowNotify("✓ Loaded From Key!", Color3.fromRGB(90, 0, 255))
    else
        ShowNotify("✕ No saved key found")
    end
end)

GetKeyBtn.MouseButton1Click:Connect(function()
    if setclipboard then 
        setclipboard(GET_KEY_URL) 
        ShowNotify("✓ Link copied to clipboard!", Color3.fromRGB(90, 0, 255)) 
    end
end)

TweenService:Create(Main, TweenInfo.new(0.8, Enum.EasingStyle.Back), {Size = UDim2.new(0, 330, 0, 280)}):Play() -- Sedikit lebih tinggi (280) untuk tombol tambahan
